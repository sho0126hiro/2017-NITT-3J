/***  mp8ex01.txt  ***/
/***  s16306  3J43  廣瀬 翔  ***/

1．課題
	1msec（1000μsec）ごとの割り込みを用いて，ストップウォッチを作成せよ。
	スタート・ストップボタンなどはキーボードのキーに割り当てる。
	また割り込み関数内で表示を行なってはいけない。グローバル変数のカウンタ変数を
	用いればよいだろう。
	キーの割り当て
	A：スタート（再開，ストップしても再開できる）　B：ストップ　C：クリア
	
	SCI1_getChar()ではなくSCI1_chkgetChar()の使用を考えなさい。
	
	どうして割り込み関数内で表示していけないか考えなさい。
	
	H8CPUからPCへのデータ転送は38400bit/secである。1バイト送信するのに１０ビット
	の転送が必要である。
	割り込み関数は，次の割り込み要求が生ずる前に作業を終了しなければならない。
	1msecごとの割り込みなら，割り込み関数内で文字をH8からPCへ転送するとしたら，
	何文字程度送信できるか考えなさい。
		
2．使用したプログラム

	#include <3048fone.h>
	#include "h8_3048fone.h"

	volatile long int time=0;/*時刻（1/100secでカウント）を保存する変数*/

	volatile int countup=0;/*時計を動かすか止めるかをコントロールする変数*/

	main()
	{
		long int time1;
		unsigned int t1,t2;
		char ch;
		initSCI1(); /*SCI-ch1の初期化*/
		initTimer1Int(1000); /*ITUch1のインターバルタイマ初期化設定*/
		                     /*単位μsなので，時間割り込み1msec*/
		E_INT();        /*CPU割り込み許可*/
		startTimer1();  /*ITUch1タイマスタート*/
		while(1) {
			ch=SCI1_chkgetChar(); /*すぐに戻ってくる*/
			if (ch=='a') countup=1;/*Aが押されたらタイマースタート*/
			else if (ch=='b') countup=0;/*Bが押されたらタイマーストップ*/
			else if (ch=='c') time=0;/*Cが押されたらリセット*/
			time1=time; /*表示の途中で変数timeが変更されたときの対策*/
			SCI1_printf("%4ld.%02ld\r",time1/1000,time1%1000); 
		}
	}

	#pragma asm
		.SECTION    MYVEC, DATA, LOCATE=H'000070
		.ORG        H'000070  ;IMIA1
		.DATA.L     _TimerIntFunc
		.SECTION    P,CODE,ALIGN=2 ;これを忘れてはいけない
	#pragma endasm

	#pragma interrupt (TimerIntFunc)
	void TimerIntFunc() /*インターバルタイマ割り込みルーチン*/
	{
		time+=countup;/*countupが1のときtimeに加算される*/
		clearTimer1Flag();  /*ITUch1タイマフラグのクリア 忘れないこと*/
	}


3．実行結果
	
	実行結果は以下のとおりである
	
	押したキー  プログラム内で読み取るキー        動作
	     A                  a               タイマースタート
	     B                  b               タイマーストップ
	     C                  c               タイマーリセット
	
	キーを押すときにshiftを押して大文字に判定させるのが面倒だと感じたので
	プログラム上では小文字アルファベットで動作するようにした．
	
4．考察
	
	1．どうして割り込み関数内で表示していけないか
		割り込み関数内で表示した場合，処理する内容が多く，CPUに大きな負荷がかかるからではないか．
		割り込み関数内のデータ転送の速度は38400bit/secと決まっている．
		よって，表示する文字数が多いとデータ転送に多く時間を使うため，CPUへの負荷がかかる．
		CPUへの負荷や，必要以上の通信が必要なため，割り込み関数内での表示は避けるべきである．
	
	2．1msecごとの割り込みなら，割り込み関数内で文字をH8からPCへ転送するとしたら，
	   何文字程度送信できるか
		H8CPUからPCへのデータ転送速度は38400bit/secであり，1bite送信するのに10bitの転送が必要である．
		
		英語（アルファベット）と数字は1文字あたり1バイト，日本語は1文字あたり2バイトである．
		
		ここで，すべて英語のアルファベットのみで送信するとき，
		38400/10=3840 ：3840文字/1sec
		
		1msecごとの割り込みの場合，
		3800/1000 = 3.8
		
		以上より3字程度と考える。

5．まとめ
	割り込み関数を用いたタイマーの設計の方法を理解した．
	また，割り込み関数内でテキストの表示をしてはいけないことも理解した．
